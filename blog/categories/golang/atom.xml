<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: GoLang | Paradigm X]]></title>
  <link href="http://paradigmx.net/blog/categories/golang/atom.xml" rel="self"/>
  <link href="http://paradigmx.net/"/>
  <updated>2014-01-01T23:22:18+08:00</updated>
  <id>http://paradigmx.net/</id>
  <author>
    <name><![CDATA[soulhacker]]></name>
    <email><![CDATA[neo@paradigmx.net]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Go for Android]]></title>
    <link href="http://paradigmx.net/blog/2012/02/05/go-for-android/"/>
    <updated>2012-02-05T19:42:00+08:00</updated>
    <id>http://paradigmx.net/blog/2012/02/05/go-for-android</id>
    <content type="html"><![CDATA[<p><a href="http://golang.org/">Go</a> is <em>the</em> language from Google and Android is <em>the</em> mobile OS from Google. The bond between them are just born with. So there should be no surprise that we can use Go to write Android programs, though some important restricts for now:
<!-- more -->
- There is no Android SDK for Go, so no system API nor GUI for Go program on Android.
- Go doesn’t support JNI for now. So Go programs have to be compiled as separate executables, wrapped as assets in apk and called within Java based apps.
- Maybe cross-compiling is really hard. We cannot build Android applications which use Cgo(C bridge for Go) on our desktop computer for now, as shown below.</p>

<p>But it’s not just a toy because of the following advantages:</p>

<ul>
  <li>Go is <em>fast</em> and all C programmers just like it.</li>
  <li>Go language is bundled with high quality libraries, especially suitable for special tasks.</li>
  <li>Go is from Google! It does have a future! Well, at least let’s hope so.</li>
</ul>

<p>Go is a very young language, thus there’s few guides or tutorials out there. But it also makes earlier investion provide more return. My friend and colleague <a href="https://twitter.com/#!/rarnu">@rarnu</a> also likes the idea of writing Android program using Go and has written <a href="http://blog.sina.com.cn/s/blog_68b671430100z4wn.html">a short tutorial</a>. I’d like to rewrite it here and fill all lost details which he was too lazy to include.</p>

<h3 id="prerequisites">Prerequisites</h3>
<ul>
  <li>C Tools
    <ul>
      <li>GCC, C standard library, bison, GNU Make and Awk</li>
    </ul>
  </li>
  <li><a href="http://mercurial.selenic.com/wiki/Download">Mercurial</a>
    <ul>
      <li><code>hg</code></li>
    </ul>
  </li>
  <li><a href="http://developer.android.com/sdk/installing.html">Android SDK</a>
    <ul>
      <li><code>adb</code></li>
    </ul>
  </li>
</ul>

<h3 id="preparing-go-language">Preparing Go Language</h3>
<p>Firstly some environment variables need to be set (better be added to <code>.bashrc</code> or <code>.zshrc</code> etc.):
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>export GOROOT=”$HOME/Code/Go/Home”
export GOBIN=”$GOROOT/bin”
export PATH=”$PATH:$GOBIN:”</pre></div>
</div>
 </figure></notextile></div>
<code>GOROOT</code> should be the folder where Go source is in and <code>GOBIN</code> should be in the system <code>PATH</code>. Double check them and issue these commands in terminal:
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>hg clone -u release https://go.googlecode.com/hg/ $GOROOT
cd $GOROOT/src
export GOOS=linux
export GOARCH=arm
./all.bash</pre></div>
</div>
 </figure></notextile></div>
Now check out <code>$GOBIN</code> folder, three commands <code>go</code> <code>godoc</code> <code>gofmt</code>(<code>go</code> command line tools) and a folder <code>linux_arm</code>(cross-compiling tools for Linux/ARM targets) should be in there. <strong>Line 2-5</strong> can be run multiple times by setting different <code>$GOOS</code> and <code>$GOARCH</code> combinations to support <code>amd64</code> <code>386</code> and <code>arm</code> instruction sets all in one install base. See “<a href="http://golang.org/doc/install/source">Installing Go from source</a>” for detail.</p>

<h3 id="hello-android-from-go">Hello Android from Go!</h3>
<p>Now create Go source files for testing. Let’s start with the most favorite ‘Hello world!’ one.
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption class='code-header' style='margin-bottom:-5px;'><span>hello.go </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre><span class="keyword">package</span> main&lt;/p&gt;

&lt;p&gt;<span class="keyword">func</span> main() {
    <span class="predefined">println</span>(<span class="error">“</span>Hello Android from Go!<span class="error">”</span>)
}</pre></div>
</div>
 </figure></notextile></div>
Compile it and generate executable:
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>CGO_ENABLED=0 GOOS=linux GOARCH=arm go build -o hello-arm hello.go</pre></div>
</div>
 </figure></notextile></div>
The last command will generate an executable named <code>hello-arm</code> which targets Linux/ARM system (i.e. Android). Now connect to an debuggable Android device and issue in the same folder:
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>adb push hello-arm /data/local/
adb shell
/data/local/hello-arm</pre></div>
</div>
 </figure></notextile></div>
If all things go right it will generate output as expected. Using the same routine showed above, all code examples on <a href="http://golang.org/">Go’s homepage</a> can be verified working well on Android devices.</p>

<h3 id="real-world-example">Real World Example</h3>
<p>The following code example is borrowed from rarnu’s <a href="http://blog.sina.com.cn/s/blog_68b671430100z4wn.html">blog post</a> and modified a bit.
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption class='code-header' style='margin-bottom:-5px;'><span>checkupdate.go </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre><span class="keyword">package</span> main&lt;/p&gt;

&lt;p&gt;<span class="keyword">import</span> (<span class="error">“</span>net/http<span class="error">”</span>; <span class="error">“</span>flag<span class="error">”</span>; <span class="error">“</span>os<span class="error">”</span>; <span class="error">“</span>strconv<span class="error">”</span>; <span class="error">“</span>encoding/json<span class="error">”</span>; <span class="error">“</span>io/ioutil<span class="error">”</span>)&lt;/p&gt;

&lt;p&gt;<span class="keyword">func</span> main() {
    flag.Parse()
    <span class="keyword">if</span> flag.NArg() != <span class="integer">1</span> {
        os.Stdout.WriteString(<span class="error">“</span><span class="error">\</span>n<span class="error">”</span>)
        <span class="keyword">return</span>
    }&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;version,_ := strconv.Atoi(flag.Arg(<span class="integer">0</span>))
res,_ := http.Get(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://rarnu.7thgen.info/api/query_software_update.php</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">if</span> res.StatusCode != <span class="integer">200</span> {
    os.Stdout.WriteString(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">return</span>
}
buf,_ := ioutil.ReadAll(res.Body)

<span class="keyword">var</span> f <span class="keyword">interface</span>{}
json.Unmarshal(buf, &amp;amp;f)
m := f.(<span class="keyword">map</span>[<span class="predefined-type">string</span>]<span class="keyword">interface</span>{});
v,_ := m[<span class="string"><span class="delimiter">&quot;</span><span class="content">lastver</span><span class="delimiter">&quot;</span></span>];
sver,_ := strconv.Atoi(v.(<span class="predefined-type">string</span>))

<span class="keyword">if</span> sver &amp;gt; version {
    fn,_ := m[<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>]
    os.Stdout.WriteString(fn.(<span class="predefined-type">string</span>) + <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">return</span>
}
os.Stdout.WriteString(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>) }</pre></div>
</div>
 </figure></notextile></div> Handling JSON data returned from web services in Go is pretty neat and clean, right? Build it as above: <div class='bogus-wrapper'><notextile><figure class='code'> <div class="CodeRay">
  <div class="code"><pre>CGO_ENABLED=0 GOOS=linux GOARCH=arm go build -o cu-arm checkupdate.go adb push cu-arm /data/local/ adb shell /data/local/cu-arm 20</pre></div>
</div>
 </figure></notextile></div> When running it on my Galaxy Nexus (ARM v7 dual-core 1.2 GHz Cortex-A9, Android 4.0.2 with kernel 3.0.8) it crashed on **line 14** - the `http.Get` call failed. Because of some issues in the cross-compiling system, all calls using Cgo will cause failure like that, at least for now. Unfortunately the `net` package depend on Cgo and nearly all useful applications need `net` package.
</code></pre>

<h3 id="call-go-code-in-android-apps">Call Go Code in Android Apps</h3>
<p>Exactly the same as calling any native executables in Android apps, which fully explained in <a href="http://gimite.net/en/index.php?Run%20native%20executable%20in%20Android%20App">this guide</a>. I’ll list a more general and accurate solution below for convenience.</p>

<p>The following Java class shows how to invoke a process in Android apps (actually it is used by Google itself), which is the base of the following guide:
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption class='code-header' style='margin-bottom:-5px;'><span>CommandResult.java </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre><span class="directive">public</span> <span class="type">class</span> <span class="class">CommandResult</span> {
    <span class="directive">public</span> <span class="predefined-type">String</span> result = <span class="error">“</span><span class="error">”</span>;
    <span class="directive">public</span> <span class="predefined-type">String</span> error = <span class="error">“</span><span class="error">”</span>;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;<span class="directive">public</span> <span class="directive">static</span> runCommand(<span class="predefined-type">String</span> command, <span class="type">boolean</span> root) {
    Log.e(<span class="string"><span class="delimiter">&quot;</span><span class="content">runCommand</span><span class="delimiter">&quot;</span></span>, command);
    
    <span class="predefined-type">Process</span> process = <span class="predefined-constant">null</span>;
    <span class="predefined-type">DataOutputStream</span> os = <span class="predefined-constant">null</span>;
    <span class="predefined-type">DataInputStream</span> stdout = <span class="predefined-constant">null</span>;
    <span class="predefined-type">DataInputStream</span> stderr = <span class="predefined-constant">null</span>;
    CommandResult ret = <span class="keyword">new</span> CommandResult();
    <span class="keyword">try</span> {
        <span class="predefined-type">StringBuffer</span> output = <span class="keyword">new</span> <span class="predefined-type">StringBuffer</span>();
        <span class="predefined-type">StringBuffer</span> error = <span class="keyword">new</span> <span class="predefined-type">StringBuffer</span>();
        <span class="keyword">if</span> (root) {
            process = <span class="predefined-type">Runtime</span>.getRuntime().exec(<span class="string"><span class="delimiter">&quot;</span><span class="content">su</span><span class="delimiter">&quot;</span></span>);
            os = <span class="keyword">new</span> <span class="predefined-type">DataOutputStream</span>(process.getOutputStream());
            os.writeBytes(command + <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            os.writeBytes(<span class="string"><span class="delimiter">&quot;</span><span class="content">exit</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
            os.flush();
        } <span class="keyword">else</span> {
            process = <span class="predefined-type">Runtime</span>.getRuntime().exec(command);
        }

        stdout = <span class="keyword">new</span> <span class="predefined-type">DataInputStream</span>(process.getInputStream());
        <span class="predefined-type">String</span> line;
        <span class="keyword">while</span> ((line = stdout.readLine()) != <span class="predefined-constant">null</span>) {
            output.append(line).append(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
        }
        stderr = <span class="keyword">new</span> <span class="predefined-type">DataInputStream</span>(process.getErrorStream());
        <span class="keyword">while</span> ((line = stderr.readLine()) != <span class="predefined-constant">null</span>) {
            error.append(line).append(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
        }
        process.waitFor();
        ret.result = output.toString().trim();
        ret.error = error.toString().trim();
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
        ret.result = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
        ret.error = e.getMessage();
    } <span class="keyword">finally</span> {
        <span class="keyword">try</span> {
            <span class="keyword">if</span> (os != <span class="predefined-constant">null</span>) {
                os.close();
            }
            <span class="keyword">if</span> (stdout != <span class="predefined-constant">null</span>) {
                stdout.close();
            }
            <span class="keyword">if</span> (stderr != <span class="predefined-constant">null</span>) {
                stderr.close();
            }
            process.destroy();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            ret.result = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
            ret.error = e.getMessage();
        }
    }

    <span class="keyword">return</span> ret;
} }</pre></div>
</div>
 </figure></notextile></div> To run a native executable (whether written in Go or not) in Android apps:
</code></pre>

<ul>
  <li>Include the binary <code>go-exec</code> in the <code>assets</code> folder.</li>
  <li>Use <code>getAssets().open("go-exec")</code> to get an <code>InputStream</code>.</li>
  <li>Write it to <code>/data/data/app-package-name/</code>, where the app has access to write files and make it executable.</li>
  <li>Make it executable using the code above, i.e. <code>CommandResult.runCommand("/system/bin/chmod 744 /data/data/app-package-name/go-exec", 0)</code></li>
  <li>Run <code>/data/data/app-package-name/go-exec</code> using the code above.</li>
</ul>

<h3 id="updates">Updates</h3>
<p><code>Go 1</code> is now live! Article updated to match changes in <code>Go 1</code>. And the <code>Go 1</code> <a href="http://golang.org/doc/go1.html">release note</a> is a must read. </p>
]]></content>
  </entry>
  
</feed>
