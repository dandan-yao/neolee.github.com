
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Go for Android - Paradigm X</title>
  <meta name="author" content="soulhacker">

  
  <meta name="description" content="Go is the language from Google and Android is the mobile OS from Google. The bond between them are just born with. So there should be no surprise &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://soulhacker.me/blog/2012/02/05/go-for-android">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Paradigm X" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/javascripts/footnote.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-28206679-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Paradigm</a></h1>
  <div id="logo">
  	<div id="logoLeft">{</div>
  	<div id="logoText">X</div>
  	<div id="logoRight">}</div>
  	<div class="clear"></div>
  </div>
  
    <h2>Vision quests of a soul hacker.</h2>
  
  <div class="clear"></div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:soulhacker.me" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://cn.soulhacker.me">Chinese Articles</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Go for Android</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-05T19:42:00+08:00" pubdate data-updated="true">Feb 5<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://golang.org/">Go</a> is <em>the</em> language from Google and Android is <em>the</em> mobile OS from Google. The bond between them are just born with. So there should be no surprise that we can use Go to write Android programs, though some important restricts for now:
<!-- more -->
- There is no Android SDK for Go, so no system API nor GUI for Go program on Android.
- Go doesn’t support JNI for now. So Go programs have to be compiled as separate executables, wrapped as assets in apk and called within Java based apps.
- Maybe cross-compiling is really hard. We cannot build Android applications which use Cgo(C bridge for Go) on our desktop computer for now, as shown below.</p>

<p>But it’s not just a toy because of the following advantages:</p>

<ul>
  <li>Go is <em>fast</em> and all C programmers just like it.</li>
  <li>Go language is bundled with high quality libraries, especially suitable for special tasks.</li>
  <li>Go is from Google! It does have a future! Well, at least let’s hope so.</li>
</ul>

<p>Go is a very young language, thus there’s few guides or tutorials out there. But it also makes earlier investion provide more return. My friend and colleague <a href="https://twitter.com/#!/rarnu">@rarnu</a> also likes the idea of writing Android program using Go and has written <a href="http://blog.sina.com.cn/s/blog_68b671430100z4wn.html">a short tutorial</a>. I’d like to rewrite it here and fill all lost details which he was too lazy to include.</p>

<h3 id="prerequisites">Prerequisites</h3>
<ul>
  <li>C Tools
    <ul>
      <li>GCC, C standard library, bison, GNU Make and Awk</li>
    </ul>
  </li>
  <li><a href="http://mercurial.selenic.com/wiki/Download">Mercurial</a>
    <ul>
      <li><code>hg</code></li>
    </ul>
  </li>
  <li><a href="http://developer.android.com/sdk/installing.html">Android SDK</a>
    <ul>
      <li><code>adb</code></li>
    </ul>
  </li>
</ul>

<h3 id="preparing-go-language">Preparing Go Language</h3>
<p>Firstly some environment variables need to be set (better be added to <code>.bashrc</code> or <code>.zshrc</code> etc.):</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>export GOROOT=&quot;$HOME/Code/Go/Home&quot;
export GOBIN=&quot;$GOROOT/bin&quot;
export PATH=&quot;$PATH:$GOBIN:&quot;</pre></div>
</div>
 </figure></notextile></div>

<p><code>GOROOT</code> should be the folder where Go source is in and <code>GOBIN</code> should be in the system <code>PATH</code>. Double check them and issue these commands in terminal:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>hg clone -u release https://go.googlecode.com/hg/ $GOROOT
cd $GOROOT/src
export GOOS=linux
export GOARCH=arm
./all.bash</pre></div>
</div>
 </figure></notextile></div>

<p>Now check out <code>$GOBIN</code> folder, three commands <code>go</code> <code>godoc</code> <code>gofmt</code>(<code>go</code> command line tools) and a folder <code>linux_arm</code>(cross-compiling tools for Linux/ARM targets) should be in there. <strong>Line 2-5</strong> can be run multiple times by setting different <code>$GOOS</code> and <code>$GOARCH</code> combinations to support <code>amd64</code> <code>386</code> and <code>arm</code> instruction sets all in one install base. See “<a href="http://golang.org/doc/install/source">Installing Go from source</a>” for detail.</p>

<h3 id="hello-android-from-go">Hello Android from Go!</h3>
<p>Now create Go source files for testing. Let’s start with the most favorite ‘Hello world!’ one.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>hello.go </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre><span class="keyword">package</span> main

<span class="keyword">func</span> main() {
    <span class="predefined">println</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Hello Android from Go!</span><span class="delimiter">&quot;</span></span>)
}</pre></div>
</div>
 </figure></notextile></div>

<p>Compile it and generate executable:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>CGO_ENABLED=0 GOOS=linux GOARCH=arm go build -o hello-arm hello.go</pre></div>
</div>
 </figure></notextile></div>

<p>The last command will generate an executable named <code>hello-arm</code> which targets Linux/ARM system (i.e. Android). Now connect to an debuggable Android device and issue in the same folder:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>adb push hello-arm /data/local/
adb shell
/data/local/hello-arm</pre></div>
</div>
 </figure></notextile></div>

<p>If all things go right it will generate output as expected. Using the same routine showed above, all code examples on <a href="http://golang.org/">Go’s homepage</a> can be verified working well on Android devices.</p>

<h3 id="real-world-example">Real World Example</h3>
<p>The following code example is borrowed from rarnu’s <a href="http://blog.sina.com.cn/s/blog_68b671430100z4wn.html">blog post</a> and modified a bit.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>checkupdate.go </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre><span class="keyword">package</span> main

<span class="keyword">import</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">net/http</span><span class="delimiter">&quot;</span></span>; <span class="string"><span class="delimiter">&quot;</span><span class="content">flag</span><span class="delimiter">&quot;</span></span>; <span class="string"><span class="delimiter">&quot;</span><span class="content">os</span><span class="delimiter">&quot;</span></span>; <span class="string"><span class="delimiter">&quot;</span><span class="content">strconv</span><span class="delimiter">&quot;</span></span>; <span class="string"><span class="delimiter">&quot;</span><span class="content">encoding/json</span><span class="delimiter">&quot;</span></span>; <span class="string"><span class="delimiter">&quot;</span><span class="content">io/ioutil</span><span class="delimiter">&quot;</span></span>)

<span class="keyword">func</span> main() {
    flag.Parse()
    <span class="keyword">if</span> flag.NArg() != <span class="integer">1</span> {
        os.Stdout.WriteString(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">return</span>
    }

    version,_ := strconv.Atoi(flag.Arg(<span class="integer">0</span>))
    res,_ := http.Get(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://rarnu.7thgen.info/api/query_software_update.php</span><span class="delimiter">&quot;</span></span>)
    <span class="keyword">if</span> res.StatusCode != <span class="integer">200</span> {
        os.Stdout.WriteString(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">return</span>
    }
    buf,_ := ioutil.ReadAll(res.Body)

    <span class="keyword">var</span> f <span class="keyword">interface</span>{}
    json.Unmarshal(buf, &amp;f)
    m := f.(<span class="keyword">map</span>[<span class="predefined-type">string</span>]<span class="keyword">interface</span>{});
    v,_ := m[<span class="string"><span class="delimiter">&quot;</span><span class="content">lastver</span><span class="delimiter">&quot;</span></span>];
    sver,_ := strconv.Atoi(v.(<span class="predefined-type">string</span>))

    <span class="keyword">if</span> sver &gt; version {
        fn,_ := m[<span class="string"><span class="delimiter">&quot;</span><span class="content">url</span><span class="delimiter">&quot;</span></span>]
        os.Stdout.WriteString(fn.(<span class="predefined-type">string</span>) + <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
        <span class="keyword">return</span>
    }
    os.Stdout.WriteString(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>)
}</pre></div>
</div>
 </figure></notextile></div>

<p>Handling JSON data returned from web services in Go is pretty neat and clean, right? Build it as above:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="CodeRay">
  <div class="code"><pre>CGO_ENABLED=0 GOOS=linux GOARCH=arm go build -o cu-arm checkupdate.go
adb push cu-arm /data/local/
adb shell
/data/local/cu-arm 20</pre></div>
</div>
 </figure></notextile></div>

<p>When running it on my Galaxy Nexus (ARM v7 dual-core 1.2 GHz Cortex-A9, Android 4.0.2 with kernel 3.0.8) it crashed on <strong>line 14</strong> - the <code>http.Get</code> call failed. Because of some issues in the cross-compiling system, all calls using Cgo will cause failure like that, at least for now. Unfortunately the <code>net</code> package depend on Cgo and nearly all useful applications need <code>net</code> package.</p>

<h3 id="call-go-code-in-android-apps">Call Go Code in Android Apps</h3>
<p>Exactly the same as calling any native executables in Android apps, which fully explained in <a href="http://gimite.net/en/index.php?Run%20native%20executable%20in%20Android%20App">this guide</a>. I’ll list a more general and accurate solution below for convenience.</p>

<p>The following Java class shows how to invoke a process in Android apps (actually it is used by Google itself), which is the base of the following guide:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption class="code-header" style="margin-bottom:-5px;"><span>CommandResult.java </span></figcaption>
 <div class="CodeRay">
  <div class="code"><pre><span class="directive">public</span> <span class="type">class</span> <span class="class">CommandResult</span> {
    <span class="directive">public</span> <span class="predefined-type">String</span> result = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">public</span> <span class="predefined-type">String</span> error = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> <span class="directive">static</span> runCommand(<span class="predefined-type">String</span> command, <span class="type">boolean</span> root) {
        Log.e(<span class="string"><span class="delimiter">&quot;</span><span class="content">runCommand</span><span class="delimiter">&quot;</span></span>, command);
        
        <span class="predefined-type">Process</span> process = <span class="predefined-constant">null</span>;
        <span class="predefined-type">DataOutputStream</span> os = <span class="predefined-constant">null</span>;
        <span class="predefined-type">DataInputStream</span> stdout = <span class="predefined-constant">null</span>;
        <span class="predefined-type">DataInputStream</span> stderr = <span class="predefined-constant">null</span>;
        CommandResult ret = <span class="keyword">new</span> CommandResult();
        <span class="keyword">try</span> {
            <span class="predefined-type">StringBuffer</span> output = <span class="keyword">new</span> <span class="predefined-type">StringBuffer</span>();
            <span class="predefined-type">StringBuffer</span> error = <span class="keyword">new</span> <span class="predefined-type">StringBuffer</span>();
            <span class="keyword">if</span> (root) {
                process = <span class="predefined-type">Runtime</span>.getRuntime().exec(<span class="string"><span class="delimiter">&quot;</span><span class="content">su</span><span class="delimiter">&quot;</span></span>);
                os = <span class="keyword">new</span> <span class="predefined-type">DataOutputStream</span>(process.getOutputStream());
                os.writeBytes(command + <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
                os.writeBytes(<span class="string"><span class="delimiter">&quot;</span><span class="content">exit</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
                os.flush();
            } <span class="keyword">else</span> {
                process = <span class="predefined-type">Runtime</span>.getRuntime().exec(command);
            }

            stdout = <span class="keyword">new</span> <span class="predefined-type">DataInputStream</span>(process.getInputStream());
            <span class="predefined-type">String</span> line;
            <span class="keyword">while</span> ((line = stdout.readLine()) != <span class="predefined-constant">null</span>) {
                output.append(line).append(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
            }
            stderr = <span class="keyword">new</span> <span class="predefined-type">DataInputStream</span>(process.getErrorStream());
            <span class="keyword">while</span> ((line = stderr.readLine()) != <span class="predefined-constant">null</span>) {
                error.append(line).append(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
            }
            process.waitFor();
            ret.result = output.toString().trim();
            ret.error = error.toString().trim();
        } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
            ret.result = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
            ret.error = e.getMessage();
        } <span class="keyword">finally</span> {
            <span class="keyword">try</span> {
                <span class="keyword">if</span> (os != <span class="predefined-constant">null</span>) {
                    os.close();
                }
                <span class="keyword">if</span> (stdout != <span class="predefined-constant">null</span>) {
                    stdout.close();
                }
                <span class="keyword">if</span> (stderr != <span class="predefined-constant">null</span>) {
                    stderr.close();
                }
                process.destroy();
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                ret.result = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>;
                ret.error = e.getMessage();
            }
        }

        <span class="keyword">return</span> ret;
    }
}</pre></div>
</div>
 </figure></notextile></div>

<p>To run a native executable (whether written in Go or not) in Android apps:</p>

<ul>
  <li>Include the binary <code>go-exec</code> in the <code>assets</code> folder.</li>
  <li>Use <code>getAssets().open("go-exec")</code> to get an <code>InputStream</code>.</li>
  <li>Write it to <code>/data/data/app-package-name/</code>, where the app has access to write files and make it executable.</li>
  <li>Make it executable using the code above, i.e. <code>CommandResult.runCommand("/system/bin/chmod 744 /data/data/app-package-name/go-exec", 0)</code></li>
  <li>Run <code>/data/data/app-package-name/go-exec</code> using the code above.</li>
</ul>

<h3 id="updates">Updates</h3>
<p><code>Go 1</code> is now live! Article updated to match changes in <code>Go 1</code>. And the <code>Go 1</code> <a href="http://golang.org/doc/go1.html">release note</a> is a must read. </p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">soulhacker</span></span>

      








  


<time datetime="2012-02-05T19:42:00+08:00" pubdate data-updated="true">Feb 5<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>Android</a>, <a class='category' href='/blog/categories/golang/'>GoLang</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://soulhacker.me/blog/2012/02/05/go-for-android/" data-via="" data-counturl="http://soulhacker.me/blog/2012/02/05/go-for-android/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2012/01/31/introducing-restkit/" title="Previous Post: Introducing RestKit">&laquo; Introducing RestKit</a>
      
      
        <a class="basic-alignment right" href="/blog/2012/03/31/soul-link/" title="Next Post: Soul Link">Soul Link &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/03/01/discourse-installation-guide/">Install Discourse on Mainstream Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/01/clojure-toolchain-reloaded/">Clojure Toolchain Reloaded</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/29/ios-7/">iOS 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/18/a-brief-guide-of-restful-soa/">A Brief Guide of (RESTful) SOA, Part III</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/17/a-brief-guide-of-restful-soa-part-ii/">A Brief Guide of (RESTful) SOA, Part II</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/neolee">@neolee</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'neolee',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - soulhacker -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'paradigmx';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://soulhacker.me/blog/2012/02/05/go-for-android/';
        var disqus_url = 'http://soulhacker.me/blog/2012/02/05/go-for-android/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
